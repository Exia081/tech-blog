{{- define "main" -}}

<div class="article-container">
  <!-- 左侧目录导航栏 -->
  {{- if .TableOfContents -}}
  <aside class="toc-sidebar" id="tocSidebar">
    <div class="toc-wrapper">
      <h3 class="toc-title">{{- if eq .Language.Lang "zh" -}}目录{{- else -}}Table of Contents{{- end -}}</h3>
      <nav id="TableOfContents" class="toc-content">
        {{- .TableOfContents -}}
      </nav>
    </div>
  </aside>
  
  <!-- 目录切换按钮 -->
  <button class="toc-toggle" id="tocToggle" aria-label="{{- if eq .Language.Lang "zh" -}}折叠/展开目录{{- else -}}Toggle TOC{{- end -}}" title="{{- if eq .Language.Lang "zh" -}}折叠/展开目录{{- else -}}Toggle Table of Contents{{- end -}}">
    <svg class="toc-toggle-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M3 4h14M3 10h14M3 16h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
  {{- end -}}

  <!-- 主内容区域 -->
  <article class="main-article">
    <header class="mb-14">
      <h1 class="my-0! pb-2.5">{{- .Title -}}</h1>

      {{- if ne .Type "page" -}}
      <div class="text-xs antialiased opacity-60">
        {{- if .Date -}}
        <time>{{- .Date | time.Format ":date_medium" -}}</time>
        {{- end -}}<!---->
        {{- $single_author := or .Params.Author site.Author.name -}}
        <!---->
        {{- if $single_author -}}
        <span class="mx-1">&middot;</span>
        <span>{{- $single_author -}}</span>
        {{- end -}}
      </div>
      {{- end -}}
    </header>

    <section>{{- .Content -}}</section>

  <!-- Post Tags -->
  {{- if .Params.tags -}}
  <footer class="mt-12 flex flex-wrap">
    {{- range .Params.tags -}} {{- $href := print (absURL "tags/") (urlize .)
    -}}
    <a
      class="mb-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] ltr:mr-1.5 rtl:ml-1.5 dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="{{- $href -}}"
      >{{- . -}}</a
    >
    {{- end -}}
  </footer>
  {{- end -}}

  <!-- Post Nav -->
  {{- if not site.Params.disablePostNavigation -}}<!---->
  {{- $pages := where site.RegularPages "Type" "in" site.Params.mainSections -}}<!---->
  {{- if and (gt (len $pages) 1) (in $pages . ) -}}
  <nav
    class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg leading-[1.2]! *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"
  >
    {{- with $pages.Next . -}}
    <a class="ltr:pr-3 rtl:pl-3" href="{{- .Permalink -}}"
      ><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>{{- .Name -}}</span></a
    >
    {{- end -}}<!---->
    {{- with $pages.Prev . -}}
    <a
      class="justify-end pl-3 ltr:ml-auto rtl:mr-auto"
      href="{{- .Permalink -}}"
      ><span>{{- .Name -}}</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a
    >
    {{- end -}}
  </nav>
  {{- end -}}<!---->
  {{- end -}}

  <!-- Disqus -->
  {{- if and site.Config.Services.Disqus.Shortname (not (eq .Params.comments
  false)) -}}
  <div class="mt-24" id="disqus_thread"></div>
  <script>
    const disqusShortname = '{{- site.Config.Services.Disqus.Shortname -}}';
    const script = document.createElement('script');
    script.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
    script.setAttribute('data-timestamp', +new Date());
    document.head.appendChild(script);
  </script>
  {{- end -}}

  <!-- GraphComment -->
  {{- if and site.Params.graphCommentId (not (eq .Params.comments false)) -}}
  <div class="mt-24" id="graphcomment"></div>
  <script type="text/javascript">
    var __semio__params = {
      graphcommentId: '{{- site.Params.graphCommentId  -}}',
      behaviour: {
        //  uid: "...",
      },
      // configure your variables here
    };

    function __semio__onload() {
      __semio__gc_graphlogin(__semio__params);
    }

    (function () {
      var gc = document.createElement('script');
      gc.type = 'text/javascript';
      gc.async = true;
      gc.onload = __semio__onload;
      gc.defer = true;
      gc.src =
        'https://integration.graphcomment.com/gc_graphlogin.js?' + Date.now();
      (
        document.getElementsByTagName('head')[0] ||
        document.getElementsByTagName('body')[0]
      ).appendChild(gc);
    })();
  </script>
  {{- end -}}

  <!-- mermaid -->
  {{- partial "mermaid.html" . -}}

  <!-- giscus comment -->
  {{- if and site.Params.giscus.repo (not (eq .Params.comments false)) -}}
  {{- $giscusLang := "en" -}}
  {{- if eq .Language.Lang "zh" -}}
    {{- $giscusLang = "zh-CN" -}}
  {{- end -}}
  <div class="giscus mt-24"></div>
  <script
    src="https://giscus.app/client.js"
    data-repo="{{- site.Params.giscus.repo -}}"
    data-repo-id="{{- site.Params.giscus.repoId -}}"
    data-category="{{- site.Params.giscus.category -}}"
    data-category-id="{{- site.Params.giscus.categoryId -}}"
    data-mapping="{{- site.Params.giscus.mapping | default (print `pathname`) -}}"
    data-strict="{{- site.Params.giscus.strict | default (print `1`) -}}"
    data-reactions-enabled="{{- site.Params.giscus.reactionsEnabled | default (print `0`) -}}"
    data-emit-metadata="{{- site.Params.giscus.emitMetadata | default (print `0`) -}}"
    data-input-position="{{- site.Params.giscus.inputPosition | default (print `top`) -}}"
    data-theme="{{- site.Params.giscus.theme | default (print `light`) -}}"
    data-lang="{{- $giscusLang -}}"
    data-loading="{{- site.Params.giscus.loading | default (print `lazy`) -}}"
    crossorigin="anonymous"
    async
  ></script>
  {{- end -}}
  </article>
</div>

<!-- TOC JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const toc = document.getElementById('TableOfContents');
  const tocSidebar = document.getElementById('tocSidebar');
  const tocToggle = document.getElementById('tocToggle');
  const article = document.querySelector('.main-article section');
  
  if (!toc || !tocSidebar || !tocToggle || !article) return;
  
  // 从localStorage读取目录显示状态
  const tocVisible = localStorage.getItem('tocVisible') !== 'false';
  if (!tocVisible) {
    tocSidebar.classList.add('hidden');
  }
  
  // 切换目录显示/隐藏
  tocToggle.addEventListener('click', function() {
    const isHidden = tocSidebar.classList.contains('hidden');
    if (isHidden) {
      tocSidebar.classList.remove('hidden');
      tocSidebar.classList.add('show');
      localStorage.setItem('tocVisible', 'true');
    } else {
      tocSidebar.classList.add('hidden');
      tocSidebar.classList.remove('show');
      localStorage.setItem('tocVisible', 'false');
    }
  });
  
  // 点击目录外部区域关闭目录（仅在小屏幕）
  document.addEventListener('click', function(e) {
    if (window.innerWidth <= 1024) {
      if (!tocSidebar.contains(e.target) && !tocToggle.contains(e.target)) {
        if (tocSidebar.classList.contains('show')) {
          tocSidebar.classList.remove('show');
        }
      }
    }
  });
  
  // 获取所有标题
  const headings = article.querySelectorAll('h1, h2, h3, h4, h5, h6');
  const tocLinks = toc.querySelectorAll('a');
  
  // 创建 IntersectionObserver 来监听标题是否在视口中
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const id = entry.target.getAttribute('id');
      const tocLink = toc.querySelector(`a[href="#${id}"]`);
      
      if (entry.isIntersecting) {
        // 移除所有active类
        tocLinks.forEach(link => link.classList.remove('active'));
        // 添加当前active类
        if (tocLink) {
          tocLink.classList.add('active');
        }
      }
    });
  }, {
    rootMargin: '-100px 0px -66%',
    threshold: 0
  });
  
  // 观察所有标题
  headings.forEach(heading => {
    if (heading.id) {
      observer.observe(heading);
    }
  });
  
  // 平滑滚动
  tocLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const targetId = link.getAttribute('href');
      const targetElement = document.querySelector(targetId);
      if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // 更新URL但不刷新页面
        history.pushState(null, null, targetId);
        
        // 在小屏幕上点击链接后自动关闭目录
        if (window.innerWidth <= 1024) {
          tocSidebar.classList.remove('show');
        }
      }
    });
  });
  
  // 窗口大小改变时处理
  let resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      if (window.innerWidth > 1024) {
        tocSidebar.classList.remove('show');
      }
    }, 250);
  });
});
</script>

{{- end -}}

